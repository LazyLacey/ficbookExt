"use strict";(self.webpackChunkficbook=self.webpackChunkficbook||[]).push([[844],{639:(e,t,i)=>{i.r(t),i.d(t,{FanficTextMenu:()=>$});var n,a=i(1101),r=i(1275);let s={class:"fanfic-text-menu"};var o=i(4569),l=i(1764),d=i.n(l),c=i(7554),u=i(6820),p=i(5315);function b(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class m{get hasSelection(){return!!this._selectionManager.value}initEvents(e,t){document.addEventListener("selectionchange",(0,p.D)(()=>e(this.getSelection()),100),{signal:t})}getSelection(){return this._selectionManager.getSelectionWithContext(30)}constructor(e,t){b(this,"id",void 0),b(this,"_selectionManager",void 0),this.id=t,this._selectionManager=new u.Z(document.querySelector(e))}}function f(e,t,i){if(!t.has(e))throw TypeError("attempted to "+i+" private field on non-instance");return t.get(e)}function h(e,t){var i=f(e,t,"get");return i.get?i.get.call(e):i.value}function y(e,t,i){!function(e,t){if(t.has(e))throw TypeError("Cannot initialize the same private elements twice on an object")}(e,t),t.set(e,i)}function g(e,t,i){var n=f(e,t,"set");return!function(e,t,i){if(t.set)t.set.call(e,i);else{if(!t.writable)throw TypeError("attempted to set read only private field");t.value=i}}(e,n,i),i}var k=new WeakMap,v=new WeakMap;class w{get someHasSelection(){return this._typoAreas.some(e=>e.hasSelection)}destroy(){h(this,k).abort()}getSelectedItem(){let e=Array.from(h(this,v)).find(e=>{let[t,i]=e;return!!i});if(!e)return null;let[t,i]=e;return{area:t,selection:i}}onSomeManagerChangedSelection(e,t,i){let n=this.getSelectedItem();h(this,v).set(e,t);let a=this.getSelectedItem();n?.selection!==a?.selection&&i(a)}constructor(e,t){for(let i of(!function(e,t,i){t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i}(this,"_typoAreas",void 0),y(this,k,{writable:!0,value:void 0}),y(this,v,{writable:!0,value:void 0}),this._typoAreas=e,g(this,k,new AbortController),g(this,v,new Map),e))i.initEvents(e=>this.onSomeManagerChangedSelection(i.id,e,t),h(this,k).signal)}}var M=i(8032);let I={class:"floating-menu-button-container"},B=["disabled"],A={class:"btn-text"},_=(0,a.aZ)({__name:"floating-menu-button",props:{isLoading:{type:Boolean,default:!1},variant:{default:"default"},disabled:{type:Boolean,default:!1},iconName:{}},setup:e=>(e,t)=>((0,a.wg)(),(0,a.iD)("div",I,[(0,a._)("button",{class:(0,o.C_)(["floating-menu-button",{"floating-menu-button--red":"red"===e.variant}]),disabled:e.disabled||e.isLoading},[e.isLoading?((0,a.wg)(),(0,a.j4)(M.Z,{key:1,"icon-name":"ic_spinner",class:"spinner"})):((0,a.wg)(),(0,a.j4)(M.Z,{key:0,"icon-name":e.iconName},null,8,["icon-name"])),(0,a._)("span",A,[(0,a.WI)(e.$slots,"default")])],10,B)]))});var E=i(1334);let T=(0,E.Z)(_,[["__scopeId","data-v-78d0f2eb"]]),S=["innerHTML"],q={class:"form-group"},x={for:"pbId"},V=["disabled"];var H=i(5997);let j=(e,t)=>{let i=new AbortController;return document.addEventListener("keydown",i=>{e(i)&&t(i)},{signal:i.signal}),i};var C=i(9088),L=i(2967);let O=(0,a.aZ)({components:{ModalFrame:H.Z},props:{fanficId:{type:Number,required:!0},partId:{type:Number,required:!1},isVisible:{type:Boolean,default:!1},typoArgs:{type:Object,required:!1}},emits:["update:isVisible"],data(){let e=j(e=>this.syncedIsVisible&&"Escape"===e.key,()=>this.hide());return{i18n:L,hotkeyAbortController:e,comment:"",isDisabled:!1}},unmounted(){this.hotkeyAbortController.abort()},computed:{syncedIsVisible:{get(){return this.isVisible},set(e){this.$emit("update:isVisible",e)}},contextElement(){if(!this.typoArgs)return null;let{context:e,selection:t}=this.typoArgs.selection,i=e.substring(0,e.indexOf('<span class="grammar_error">')),n=document.createElement("span");n.innerHTML=i;let a=e.substring(e.indexOf("</span>")),r=document.createElement("span");r.innerHTML=a;let s=document.createElement("span");s.innerHTML=t;let o=n.innerHTML+`<span class="grammar_error">${s.innerText}</span>`+r.innerHTML,l=document.createElement("div");return l.innerHTML="..."+o+"...",l}},watch:{async syncedIsVisible(){this.syncedIsVisible?(await this.$nextTick(),this.$refs.textarea.focus()):this.comment=""}},methods:{async submitTypo(){if(this.isDisabled)return;this.isDisabled=!0;let{fanficId:e,partId:t}=this;try{let i=await (0,C.lY)({fanficId:e,partId:t},(0,c.k)(this.typoArgs.selection.context),this.typoArgs.area,this.comment);d().success(i.message),this.hide(),this.isDisabled=!1}catch(e){console.error(e),d().warning(e.error),this.isDisabled=!1}},hide(){this.syncedIsVisible=!1}}}),F=(0,E.Z)(O,[["render",function(e,t,i,n,s,l){let d=(0,a.up)("ModalFrame");return(0,a.wg)(),(0,a.j4)(d,{"is-visible":e.syncedIsVisible,"onUpdate:isVisible":t[2]||(t[2]=t=>e.syncedIsVisible=t)},{title:(0,a.w5)(()=>[(0,a.Uk)((0,o.zw)(e.i18n.t("public-beta.modal-title")),1)]),body:(0,a.w5)(()=>[(0,a._)("div",{class:"beta-context",innerHTML:e.contextElement?.innerHTML},null,8,S),(0,a._)("form",q,[(0,a._)("label",x,(0,o.zw)(e.i18n.t("public-beta.modal-suggestion")),1),(0,a.wy)((0,a._)("textarea",{"onUpdate:modelValue":t[0]||(t[0]=t=>e.comment=t),id:"pbId",class:"form-control",maxlength:"250",ref:"textarea"},null,512),[[r.nr,e.comment]])])]),footer:(0,a.w5)(()=>[(0,a._)("button",{onClick:t[1]||(t[1]=function(){for(var t=arguments.length,i=Array(t),n=0;n<t;n++)i[n]=arguments[n];return e.submitTypo&&e.submitTypo(...i)}),class:"btn btn-primary",disabled:e.isDisabled},(0,o.zw)(e.i18n.t("common.send")),9,V)]),_:1},8,["is-visible"])}]]);var Z=i(1120);!function(e){e[e.Button=0]="Button",e[e.Hotkey=1]="Hotkey"}(n||(n={}));let N={[n.Button]:Z.O.OpenPublicBetaModalWithButtonClick,[n.Hotkey]:Z.O.OpenPublicBetaModalWithHotkey},P=(0,a.aZ)({components:{FloatingMenuButton:T,PublicBetaModal:F},props:{isEnabled:{type:Boolean,required:!0},typoAreas:{type:Object,required:!0},fanficId:{type:Number,required:!0},partId:{type:Number,required:!1}},computed:{isModalVisible(){return!!this.modalArgs},hasSelection(){return!!this.publicBetaManager?.someHasSelection}},data(){let e=j(e=>this.hasSelection&&!this.isModalVisible&&e.ctrlKey&&"Enter"===e.key,()=>this.openTypoModal(n.Hotkey));return{i18n:L,OpenModalEventSender:n,hotkeyAbortController:e,modalArgs:null,selectionArgs:null,publicBetaManager:null}},mounted(){let e=Object.entries(this.typoAreas).map(e=>{let[t,i]=e;return new m(t,i)});this.publicBetaManager=new w(e,e=>this.selectionArgs=e)},methods:{openTypoModal(e){if(!this.isEnabled){d().error(L.t("public-beta.disabled"));return}this.selectionArgs&&this.validateSelection(this.selectionArgs)&&(this.modalArgs=this.selectionArgs,(0,Z.N)(N[e]))},validateSelection(e){let{selection:t}=e,i=t.selection;return i?!(i.length>255)||(d().error(L.t("public-beta.error-length")),!1):(d().error(L.t("public-beta.error-selection")),!1)}},unmounted(){this.publicBetaManager.destroy(),this.hotkeyAbortController.abort()}}),D=(0,E.Z)(P,[["render",function(e,t,i,n,s,l){let d=(0,a.up)("PublicBetaModal"),c=(0,a.up)("FloatingMenuButton");return(0,a.wy)(((0,a.wg)(),(0,a.j4)(c,{onClick:t[1]||(t[1]=t=>e.openTypoModal(e.OpenModalEventSender.Button)),disabled:!e.isEnabled,iconName:"ic_spell-check"},{default:(0,a.w5)(()=>[(0,a.Uk)((0,o.zw)(e.i18n.t("public-beta.report-button"))+" ",1),(0,a.Wm)(d,{"is-visible":e.isModalVisible,"onUpdate:isVisible":t[0]||(t[0]=t=>e.modalArgs=null),typoArgs:e.modalArgs,fanficId:e.fanficId,partId:e.partId},null,8,["is-visible","typoArgs","fanficId","partId"])]),_:1},8,["disabled"])),[[r.F8,e.hasSelection]])}]]);var W=i(2007);let z=(0,a.aZ)({components:{PublicBetaButton:D,BookmarkMenu:W.BookmarkMenu},props:{fanficId:{type:Number,required:!0},partId:{type:Number,required:!1},savedBookmark:{type:Object,required:!1},isPublicBetaEnabledForFanfic:{type:Boolean,required:!0},isBlacklist:{type:Boolean,required:!0},typoAreas:{type:Object,required:!0}},computed:{enabledFeatures(){let{isPremium:e}=window.ficbook.userInfo,t=document.querySelector(".js-part-text");return{bookmarks:e&&t,publicBeta:!this.isBlacklist}}}}),U=(0,E.Z)(z,[["render",function(e,t,i,n,o,l){let d=(0,a.up)("PublicBetaButton"),c=(0,a.up)("BookmarkMenu");return(0,a.wg)(),(0,a.iD)("div",s,[e.enabledFeatures.publicBeta?((0,a.wg)(),(0,a.j4)(r.uT,{key:0,name:"fade-in"},{default:(0,a.w5)(()=>[(0,a.Wm)(d,{isEnabled:e.isPublicBetaEnabledForFanfic,typoAreas:e.typoAreas,fanficId:e.fanficId,partId:e.partId},null,8,["isEnabled","typoAreas","fanficId","partId"])]),_:1})):(0,a.kq)("v-if",!0),e.enabledFeatures.bookmarks?((0,a.wg)(),(0,a.j4)(r.uT,{key:1,name:"fade-in"},{default:(0,a.w5)(()=>[(0,a.Wm)(c,{fanficId:e.fanficId,partId:e.partId,savedBookmark:e.savedBookmark},null,8,["fanficId","partId","savedBookmark"])]),_:1})):(0,a.kq)("v-if",!0)])}],["__scopeId","data-v-1c5dcfcc"]]),$=U}}]);